---
title: "Kinetic Models"
output: 
  html_document:
    theme: lumen
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: false
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=10)

if (!require(pacman)) install.packages("pacman")
pacman::p_load(plyr, dplyr, tidyr, DT, data.table, lubridate, ggplot2, plotly, nlme, MuMIn)

dir <- dirname(file.choose())
setwd(dir)

filenames <- list.files(dir, pattern="*.csv") ## Keep in folder only the .csv files that are of interest
```

## Data Input

### Load and massage data

#### Fixed data

```{r load and massage data}
df <- lapply(filenames, function(x) {
  read.csv(x, stringsAsFactors = FALSE) %>%
    mutate(Min=row_number()) %>%
    gather(Time, Speed, -phase, -Min) %>%
    rename(Temp=phase)
  })
names(df) <- filenames
df <- do.call("rbind", df) %>%
  mutate(Name=row.names(.),
         Name=gsub("\\..*", "", Name)) %>%
  separate(Name, c("Experiment", "Sex", "Condition", "Box"), "_") %>%
  filter(!is.na(Speed)) %>%
  arrange(Box, Experiment, Condition, Sex, Time, Min, Temp) %>%
  group_by(Box, Experiment, Condition, Sex, Time)

grps <- group_indices(df)

df <- df %>%
  ungroup() %>%
  mutate(FlyID=grps) %>%
  group_by(Experiment, Sex) %>%
  mutate(FlyID=FlyID-min(FlyID)+1) %>%
  ungroup() %>%
  mutate(Time=hm(Time),
         Hour=hour(round_date(as_datetime(Time), unit="hour"))) %>%
  mutate(ToD=case_when(.$Hour < 12 ~ "Morning",
                       .$Hour >= 12 & .$Hour < 15 ~ "Siesta",
                       .$Hour >= 15 & .$Hour < 18 ~ "Afternoon",
                       .$Hour >= 18 ~ "Evening")) %>%
  select(Experiment, Sex, Condition, Box, FlyID, Hour, ToD, Min, Temp, Speed) %>%
  filter(Min>7, Experiment=="CurveFail")

rm(grps)

datatable(df)
```

#### Mean data
```{r data means}
df_mean <- df %>%
  group_by(Experiment, Condition, Box, Sex, Min, Temp) %>%
  summarise(N=n(), sd=sd(Speed, na.rm=TRUE), se=sd(Speed, na.rm=TRUE)/sqrt(n()), Speed=mean(Speed, na.rm=TRUE)) %>%
  group_by(Experiment, Condition, Box, Sex) %>%
  mutate(ciMult = qt(0.475 + .5, N-1),
         ci=se*ciMult) %>%
  ungroup() %>%
  select(Experiment, Sex, Min, Temp, Speed, everything(), -ciMult)

datatable(df_mean)
```

## Plot data

### All data
```{r plot data}
ggplot(df, aes(x=as.factor(Min), y=Speed, color=Sex)) +
  geom_boxplot() +
  scale_x_discrete(breaks=df$Min, labels=df$Temp) +
  scale_y_continuous(limits = c(0, NA)) +
  xlab("Temperature (C)") +
  facet_grid(Experiment ~ Sex) +
  theme_bw() +
  theme(legend.position="none",
        axis.text.x = element_text(angle = 90, hjust = 1))
```

### Mean data

```{r plot mean data}
ggplot(df_mean, aes(x=as.factor(Min), y=Speed, color=Box, fill=Box, group=1)) +
  geom_errorbar(aes(ymin=Speed-se, ymax=Speed+se), width=0.5) +
  geom_point(size=3, shape=21, alpha=0.5) +
  scale_x_discrete(breaks=df$Min, labels=df$Temp) +
  scale_y_continuous(limits = c(0, NA)) +
  xlab("Temperature (C)") +
  facet_grid(Condition ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Speed over temperature

```{r speed over tempplot, warning=FALSE}
ggplot(df, aes(x=Temp, y=Speed, color=paste0(Condition, Box), shape=Sex)) +
  geom_point() +
  geom_smooth(aes(group=1), method = 'loess') +
  scale_x_continuous(breaks=unique(df$Temp), labels=unique(df$Temp)) +
  scale_y_continuous(limits = c(0, NA)) +
  theme_bw()
```

## Comparison of thermal performance curves

### Regression Analysis

```{r regression}
lm <- lm(Speed ~ poly(Temp, 3) + Sex + Condition + Box, data=df_mean)

summary(lm)

df_plot <- df_mean %>%
  mutate(pred=predict(lm,.))

ggplot(df_plot, aes(x=as.factor(Min), y=Speed, color=Box, fill=Box, group=1)) +
  geom_errorbar(aes(ymin=Speed-se, ymax=Speed+se), width=0.5) +
  geom_point(size=3, shape=21, alpha=0.5) +
  scale_x_discrete(breaks=df$Min, labels=df$Temp) +
  scale_y_continuous(limits = c(0, NA)) +
  xlab("Temperature (C)") +
  facet_grid(Condition ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


